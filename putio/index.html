<!DOCTYPE html>
<html>

<body>
    <h1>Put.io</h1>
    <p>Previewer</p>

    <div id="auth">
        <a
            href="https://app.put.io/authenticate?client_id=5165&redirect_uri=https%3A%2F%2Fodedhb.github.io%2Fputio&response_type=token">Connect
            via Put.io</a>
    </div>

    <div id="main_view"></div>
</body>

</html>

<script>
    if (window.location.hash) {
        document.getElementById("auth").style.display = "none";
        let token = getHashValue("token");
        console.log(token);

        showVideos(token);
    }

    function getHashValue(key) {
        var matches = location.hash.match(new RegExp(key + '=([^&]*)'));
        return matches ? matches[1] : null;
    }

    async function showVideos(element, token, parentID) {
        let listUrl = 'https://api.put.io/v2/files/list?sort_by=DATE_DESC&stream_url=true&stream_url_parent=true&mp4_stream_url=true&mp4_stream_url_parent=true&mp4_status=true';
        if (parentID) {
            listUrl += "&parent_id=" + parentID
        }

        let result = await fetch(listUrl, {
            method: 'GET',
            headers: {
                Authorization: "Bearer " + token,
                'Content-Type': 'application/json'
            }
        });
        console.log(result);
        let contents = await result.json();
        console.log("contents", contents);
        for (let file of contents.files) {
            await showVideo(element, token, file);
        }

        document.getElementById("main_view").innerHTML
            += "______________<br><br>";
    }

    async function showVideo(element, token, file) {
        console.log("file", file);
        let element = element || document.getElementById("main_view");
        if (file.file_type === "FOLDER") {
            element.innerHTML
                += `<div onclick="showVideos(this,'${token}',${file.id})"><h3>${file.name}</h3></div>`;
        } else if (file.stream_url) {
            element.innerHTML
                += `<div><a href="https://app.put.io/files/${file.id}"><video width="320" height="240" controls poster="${file.screenshot}"><source src="${file.stream_url}#t=60"></video><div>${file.name}</div></a></div>`;
        } else if (file.screenshot) {
            element.innerHTML
                += `<div><a href="https://app.put.io/files/${file.id}"><img src="${file.screenshot}" /><div>${file.name}</div></a></div>`;
        }
    }
</script>